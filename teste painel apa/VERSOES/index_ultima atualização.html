<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão à Vista APA</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
       /* ==================== Estilos do Cabeçalho (com menu e ranking) ==================== */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background-color: #0C296C;
    color: white;
    z-index: 1000;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
}

header img {
    width: 230px;
    height: auto;
}

.header-title {
    margin: 0;
    font-size: 40px;
    font-family: 'Montserrat', sans-serif;
    flex-grow: 1;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.navbar-toggler {
    border: none;
    padding: 0;
}
.navbar-toggler:focus {
    box-shadow: none;
}
        
@media (max-width: 768px) {
    header {
        padding: 0 15px;
    }
    header img {
        display: none;
    }
    header h2 {
        font-size: 24px;
    }
    .header-spacer {
        display: none;
    }
}
        
        /* ==================== Estilos Gerais ==================== */
        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #e6e9f0;
            color: #2c3e50;
            padding: 20px;
            padding-top: 120px;
        }
        
        body.fullscreen-mode {
            padding-top: 120px;
        }
        
        body.fullscreen-mode .import-section,
        body.fullscreen-mode #fullscreenBtn,
        body.fullscreen-mode .card #fullscreenBtn {
    display: none;
}

        .dashboard-container {
            max-width: 100%;
            height: 100%;
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box;
        }

        .card {
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        
        .title-card {
            text-align: center;
        }

        .import-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .file-upload-container, .paste-data-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        #fileInput {
            display: none;
        }

        .custom-file-upload {
            border: 1px solid #c0d0e0;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .custom-file-upload:hover {
            background-color: #d0e0f0;
        }

        .import-btn, .modal-btn {
            padding: 8px 16px;
            background-color: #005f99;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .import-btn:hover, .modal-btn:hover {
            background-color: #004d80;
        }
        
        #buttons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        #pasteData {
            width: 100%;
            height: 100px;
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            flex-grow: 1; 
            overflow: initial;
        }

        aside {
            flex-basis: 250px;
            background-color: #fff;
            order: 2;
        }

        .table-container {
            flex: 1; 
            min-width: 60%; 
            overflow-x: auto;
            order: 1;
        }

        .header-info {
            font-size: 1em; 
            font-weight: bold;
        }

        #painelTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            min-width: 800px;
        }

        #painelTable th, #painelTable td {
            border: 1px solid #ddd;
            padding: 5px; 
            text-align: left;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
        }

        #painelTable th:first-child,
        #painelTable td:first-child {
            width: 60px; 
        }

        #painelTable th:nth-child(4),
        #painelTable td:nth-child(4) {
            width: 250px;
        }
        
        #painelTable th:nth-child(5), #painelTable td:nth-child(5) {
            width: 70px;
            min-width: 70px;
            max-width: 70px;
        }
        #painelTable th:nth-child(6), #painelTable td:nth-child(6) {
            min-width: 100px;
            max-width: 140px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #painelTable th:nth-child(7), #painelTable td:nth-child(7) {
            width: 100px;
        }
        #painelTable th:nth-child(8), #painelTable td:nth-child(8) {
            width: 70px;
        }
        #painelTable th:nth-child(9), #painelTable td:nth-child(9) {
            width: 70px;
        }
        #painelTable th:nth-child(10), #painelTable td:nth-child(10) {
            width: 60px;
            text-align: center;
        }
        
        #painelTable th:last-child, #painelTable td:last-child {
            white-space: normal;
            word-wrap: break-word;
        }
        
        #painelTable th {
            background-color: #003366;
            color: white;
            font-size: 0.9em;
            text-transform: uppercase;
            text-align: center;
            white-space: normal;
            line-height: 1.2;
        }
        
        #painelTable td {
            white-space: nowrap;
        }

        #painelTable tr:hover {
            background-color: #ADD8E6 !important;
        }
        
        .cinza-claro {
            background-color: #D3D3D3 !important;
        }
        
        .status-cell-table {
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .status-dot-table {
            height: 15px;
            width: 15px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid black;
        }
        
        .legend-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px 0;
            border-radius: 4px;
            padding: 15px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }
        
        .legend-dot {
            height: 15px;
            width: 15px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid black;
        }
        
        .legend-dot.white, .status-dot-table.white {
            background-color: transparent;
        }
        .legend-dot.blue, .status-dot-table.blue {
            background-color: #007bff;
        }
        .legend-dot.yellow, .status-dot-table.yellow {
            background-color: #ffc107;
        }
        .legend-dot.green, .status-dot-table.green {
            background-color: #28a745;
        }
        .legend-dot.red, .status-dot-table.red {
            background-color: #dc3545;
        }
        .legend-dot.black, .status-dot-table.black {
            background-color: #000;
        }

        #painelTable td input[type="time"] {
            font-size: 1em;
        }

        #painelTable input,
        #painelTable select {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            padding: 3px; 
            border-radius: 3px;
            font-size: 0.8em;
        }
        
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column; 
            }
            aside, .table-container {
                order: initial;
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            header {
                padding: 0 15px;
            }
            header img {
                display: none;
            }
            header h2 {
                font-size: 24px;
            }
            .header-spacer {
                display: none;
            }
            .legend-container {
                gap: 10px;
                justify-content: flex-start;
            }
            .legend-item {
                font-size: 0.9em;
            }
        }
        
        .summary-section {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }
        .summary-section:last-child {
            border-bottom: none;
        }
        .summary-title {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            grid-column: 1 / span 2;
            margin-bottom: 5px;
        }
        .summary-item-label {
            font-size: 0.9em;
        }
        .summary-item-value {
            font-weight: bold;
            text-align: right;
        }
        .summary-item-value.percentage {
            font-size: 0.9em;
            color: #555;
            text-align: left;
        }
        
        .resumo-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
            text-align: center;
        }
        .resumo-table th, .resumo-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .resumo-table th {
            background-color: #003366;
            color: white;
            font-weight: bold;
        }
        .resumo-table td.left-align {
            text-align: left;
        }

        .summary-card-noturno {
            background-color: #D3D3D3;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Novas Classes para os botões e modal */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            cursor: pointer;
        }

        .modal-content h3 {
            margin-top: 0;
        }

        .modal-content form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-content label {
            text-align: left;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .modal-content input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    
    <header>
    <img src="imagem/baixados.png" alt="Logo">
    <h2 class="header-title">GESTÃO À VISTA APA</h2>
    <nav class="navbar navbar-dark bg-transparent">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#rankingMenu" aria-controls="rankingMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="rankingMenu">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link text-white" href="#">RANKING CONFERENTES</a>
                </li>
            </ul>
        </div>
    </nav>
</header>

    <div class="dashboard-container">
        <section class="import-section card">
            <p style="text-align: center;">**Escolha um método de importação:**</p>
            <div class="file-upload-container">
                <input type="file" id="fileInput" accept=".csv" />
                <label for="fileInput" class="custom-file-upload">
                    1. Importar de Arquivo CSV
                </label>
                <button id="importarBtn" class="import-btn">Processar Arquivo</button>
            </div>
            
            <p style="text-align: center;">OU</p>
            
            <div class="paste-data-container">
                <div style="flex-grow: 1;">
                    <textarea id="pasteData" placeholder="2. Cole os dados da sua planilha do Excel aqui..."></textarea>
                </div>
                <button id="pasteBtn" class="import-btn">Colar e Importar</button>
            </div>
        </section>
        
        <div class="main-content">
            <div class="table-container card">
                <table id="painelTable">
                    <thead>
                        <tr>
                            <th>JANELA</th>
                            <th>CARRETA<br>NA DOCA</th>
                            <th>PLACA<br>DO VEÍCULO</th>
                            <th>CLIENTE</th>
                            <th>VOLUMES</th>
                            <th>CONFERENTE</th>
                            <th>DOCA</th>
                            <th>INÍCIO</th>
                            <th>FIM</th>
                            <th>STATUS</th>
                            <th>OBS</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            
            <aside class="card">
                <h2>Resumo do Painel</h2>
                <div class="legend-container">
                    <div class="legend-item">
                        <div class="legend-dot white"></div>
                        <span>No Prazo</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot blue"></div>
                        <span>Em andamento</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot yellow"></div>
                        <span>Em andamento com atraso</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot red"></div>
                        <span>Em Atraso ou Perdeu Janela</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot green"></div>
                        <span>Finalizado no horário</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot black"></div>
                        <span>Sem informações</span>
                    </div>
                </div>
                <div id="summary-info">
                    </div>
            </aside>
        </div>
        
        <div class="card" style="text-align: center;">
             <button id="fullscreenBtn" class="import-btn" style="width: 100%;">Visualizar em Tela Cheia</button>
             <div class="button-group">
                <button id="addConferenteBtn" class="import-btn">Inserir Novo Conferente</button>
                <button id="addObsBtn" class="import-btn">Inserir Nova Observação</button>
                <button id="exportExcelBtn" class="import-btn">Exportar para Excel</button>
             </div>
        </div>
    </div>
    
    <div id="modalConferente" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="closeConferenteModal">&times;</span>
            <h3>Inserir Novo Conferente</h3>
            <form id="formConferente">
                <label for="inputConferente">Nome do Conferente:</label>
                <input type="text" id="inputConferente" name="conferente" required>
                <button type="submit" class="modal-btn">Adicionar Conferente</button>
            </form>
        </div>
    </div>

    <div id="modalObs" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="closeObsModal">&times;</span>
            <h3>Inserir Nova Observação</h3>
            <form id="formObs">
                <label for="inputObs">Nova Observação:</label>
                <input type="text" id="inputObs" name="observacao" required>
                <button type="submit" class="modal-btn">Adicionar Observação</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const importarBtn = document.getElementById('importarBtn');
            const pasteData = document.getElementById('pasteData');
            const pasteBtn = document.getElementById('pasteBtn');
            const tabelaCorpo = document.querySelector('#painelTable tbody');
            const summaryInfoDiv = document.getElementById('summary-info');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const addConferenteBtn = document.getElementById('addConferenteBtn');
            const addObsBtn = document.getElementById('addObsBtn');
            const modalConferente = document.getElementById('modalConferente');
            const modalObs = document.getElementById('modalObs');
            const closeConferenteModal = document.getElementById('closeConferenteModal');
            const closeObsModal = document.getElementById('closeObsModal');
            const formConferente = document.getElementById('formConferente');
            const formObs = document.getElementById('formObs');
            const inputConferente = document.getElementById('inputConferente');
            const inputObs = document.getElementById('inputObs');

            
            let estadoPorPlaca = {};
            let rawDataLines = []; 
            let currentCabecalho = [];
            const localStorageKeyEstado = 'painelCarregamentoEstado';
            const localStorageKeyDados = 'painelCarregamentoDados';
            const localStorageKeyConferentes = 'painelConferentes';
            const localStorageKeyObs = 'painelObservacoes';
            let notificationTimer = null;

            const cabecalhoPadrao = ['Janela', 'Local', 'Hora Prog. Distribuição', 'Carreta na Portaria', 'Entrada Portaria', 'Carreta na Doca', 'Data a Expedir', 'Transportador', 'Placa', 'PM', 'Remessa', 'Cliente', 'Destino', 'Agenda', 'Volume', 'STATUS', 'OBS', 'OBS. LOG', 'Saída Expedição', 'Liberação Fiscal/Portaria', 'Historico de Recusa', 'Cubagem Maxload'];
            
            const colunaMap = {
                'Janela': 'JANELA',
                'Carreta na Doca': 'CARRETA NA DOCA',
                'Placa': 'PLACA DO VEÍCULO',
                'Cliente': 'CLIENTE',
                'Volume': 'VOLUMES',
            };
            
            let conferentes = ['Selecione...', 'ALMREP', 'ARIONALDO', 'ARLLYSON', 'CÍCERO', 'ERISOM', 'ERNANDES', 'FABIANO', 'FÁBIO', 'FRANCIE', 'ISMAEL', 'JOEL', 'MICIANO', 'TIAGO', 'WENDEL'];
            let observacoesList = [
                "ABSENTEÍSMO CAPATAZIA",
                "ABSENTEÍSMO ESMALTEC",
                "AGUARDANDO COMPLEMENTO DE CARGA",
                "ANTECIPADO",
                "APA EM FALHAS CONSTANTES",
                "APA EM MANUTENÇÃO",
                "ATRASO - COMERCIAL DIURNO",
                "ATRASO - COMERCIAL NOTURNO",
                "ATRASO - PROGRAMAÇÃO LOGÍSTICA",
                "ATRASO - QUEDA DE CONTENTOR NO APA",
                "ATRASO - VEÍCULO NÃO SE APRESENTOU",
                "ATRASO - WMS SEM CONEXÃO COM A REDE",
                "BLOQUEADO PARA APLICAÇÕES DE MELHORIAS NO WMS I9 SUPPLY",
                "CARREGAMENTO NO APA2",
                "DESISTÊNCIA DO MOTORISTA",
                "FALHA OPERACIONAL DA EXPEDIÇÃO",
                "LOGÍSTICA REVERSA",
                "PEDIDO POSTERGADO PELO CLIENTE",
                "PRODUTOS EM PRODUÇÃO",
                "PRODUTOS MOLHADOS",
                "RECUSADO - VEÍCULO COM INFILTRAÇÃO",
                "RECUSADO - VEÍCULO INADEQUADO",
                "RECUSADO - VEÍCULO NÃO COUBE A CARGA",
                "SEM PROGRAMAÇÃO",
                "PERDEU JANELA - SEM PROGRAMAÇÃO", 
                "TREINAMENTO COLABORADORES NOVO WMS",
                "RAMP UP WMS I9 SUPPL"
            ];
            const docas = ['Selecione...', ...Array.from({length: 10}, (_, i) => `DOCA${i + 1}`)];
            
            function sortAndSaveConferentes() {
                const selectOption = 'Selecione...';
                let conferentesTemporarios = conferentes.filter(c => c !== selectOption);
                
                const uniqueConferentes = [...new Set(conferentesTemporarios)];
                
                uniqueConferentes.sort((a, b) => a.localeCompare(b));
                
                conferentes = [selectOption, ...uniqueConferentes];
                
                localStorage.setItem(localStorageKeyConferentes, JSON.stringify(conferentes));
            }

            function sortAndSaveObservacoes() {
                const uniqueObservacoes = [...new Set(observacoesList)];
                observacoesList = uniqueObservacoes.sort();
                localStorage.setItem(localStorageKeyObs, JSON.stringify(observacoesList));
            }
            
            function loadPersistentData() {
                const savedConferentes = localStorage.getItem(localStorageKeyConferentes);
                if (savedConferentes) {
                    conferentes = JSON.parse(savedConferentes);
                }
                const savedObs = localStorage.getItem(localStorageKeyObs);
                if (savedObs) {
                    observacoesList = JSON.parse(savedObs);
                }
            }

            loadPersistentData();

            function requestNotificationPermission() {
                if (!("Notification" in window)) {
                    console.error("Este navegador não suporta notificações de desktop.");
                } else if (Notification.permission === "default") {
                    Notification.requestPermission();
                }
            }

            function sendUpdateNotification() {
                if (Notification.permission === "granted") {
                    console.log("Notificação de lembrete enviada.");
                    new Notification("Lembrete: Atualize o Painel APA", {
                        body: "Uma nova atualização de dados é necessária para manter o painel à vista.",
                        icon: 'imagem/baixados.png'
                    });
                } else {
                    console.log("Permissão para notificação não concedida. Não é possível enviar o lembrete.");
                }
            }
            
            function scheduleNextNotification() {
                if (notificationTimer) {
                    clearTimeout(notificationTimer);
                }
                notificationTimer = setTimeout(() => {
                    sendUpdateNotification();
                    scheduleNextNotification();
                }, 30 * 60 * 1000);
            }
            
            function salvarEstado() {
                try {
                    localStorage.setItem(localStorageKeyEstado, JSON.stringify(estadoPorPlaca));
                } catch (e) {
                    console.error("Erro ao salvar o estado no localStorage: ", e);
                }
            }

            function carregarEstado() {
                try {
                    const savedData = localStorage.getItem(localStorageKeyEstado);
                    if (savedData) {
                        estadoPorPlaca = JSON.parse(savedData);
                    }
                } catch (e) {
                    console.error("Erro ao carregar o estado do localStorage: ", e);
                    estadoPorPlaca = {}; 
                }
            }
            
            function salvarDados(dados, cabecalho) {
                try {
                    localStorage.setItem(localStorageKeyDados, JSON.stringify({ dados, cabecalho }));
                } catch (e) {
                    console.error("Erro ao salvar os dados no localStorage: ", e);
                }
            }

            function carregarDados() {
                try {
                    const savedData = localStorage.getItem(localStorageKeyDados);
                    if (savedData) {
                        const { dados, cabecalho } = JSON.parse(savedData);
                        rawDataLines = dados;
                        currentCabecalho = cabecalho;
                        renderizarTabela(rawDataLines, currentCabecalho, false);
                    } else {
                        atualizarResumo(); 
                    }
                } catch (e) {
                    console.error("Erro ao carregar os dados do localStorage: ", e);
                    localStorage.removeItem(localStorageKeyDados); 
                    atualizarResumo(); 
                }
            }

            carregarDados();

            function parseCsvLine(line) {
                const result = [];
                let inQuotes = false;
                let currentField = '';
            
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
            
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            currentField += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                result.push(currentField.trim());
                
                return result.map(field => field.replace(/^"|"$/g, ''));
            }

            function parseData(rawData) {
                const csvData = rawData.replace(/\t/g, ',');
                const linhas = csvData.trim().split('\n');
                
                if (linhas.length < 1) {
                    throw new Error("Dados inválidos. Não foram encontradas linhas.");
                }

                let cabecalho = null;
                let dados = [];
                let cabecalhoEncontrado = false;
                
                for (let i = 0; i < linhas.length; i++) {
                    const linha = linhas[i].trim();
                    const colunas = parseCsvLine(linha);
                    
                    if (colunas.some(c => c.toLowerCase().includes('janela') || c.toLowerCase().includes('placa') || c.toLowerCase().includes('volume'))) {
                        cabecalho = colunas;
                        dados = linhas.slice(i + 1);
                        cabecalhoEncontrado = true;
                        break;
                    }
                }
                
                if (!cabecalhoEncontrado) {
                    return { cabecalho: cabecalhoPadrao, dados: linhas };
                }

                return { cabecalho, dados };
            }
            
            function atualizarStatusCor(inicioTime, fimTime, obsValue, carretaDocaTime, statusDot, isIncomplete) {
                statusDot.classList.remove('blue', 'yellow', 'green', 'red', 'white', 'black');
                
                if (obsValue === 'PERDEU JANELA - SEM PROGRAMAÇÃO') {
                    statusDot.classList.add('red');
                    return;
                }
                
                if (isIncomplete) {
                    statusDot.classList.add('black');
                    return;
                }
                
                if (!inicioTime && !fimTime && obsValue && obsValue !== '') {
                    statusDot.classList.add('red');
                    return;
                }
                
                if (fimTime) {
                    let [docaHours, docaMinutes] = carretaDocaTime.split(':').map(Number);
                    let [fimHours, fimMinutes] = fimTime.split(':').map(Number);
                    const dateNow = new Date();
                    const carretaDocaDate = new Date(dateNow.getFullYear(), dateNow.getMonth(), dateNow.getDate(), docaHours, docaMinutes);
                    let fimDate = new Date(dateNow.getFullYear(), dateNow.getMonth(), dateNow.getDate(), fimHours, fimMinutes);
    
                    if (fimDate < carretaDocaDate) {
                        fimDate.setDate(fimDate.getDate() + 1);
                    }
    
                    const durationInMinutes = (fimDate.getTime() - carretaDocaDate.getTime()) / (1000 * 60);
    
                    if (durationInMinutes > 60) {
                        statusDot.classList.add('red');
                    } else {
                        statusDot.classList.add('green');
                    }
                    return;
                }
                
                if (inicioTime) {
                    if (inicioTime <= carretaDocaTime) {
                        statusDot.classList.add('blue');
                    } else {
                        statusDot.classList.add('yellow');
                    }
                    return;
                }

                statusDot.classList.add('white');
            }

            function renderizarTabela(dados, cabecalho, isNewImport = true) {
                tabelaCorpo.innerHTML = '';
                
                salvarDados(dados, cabecalho);
                carregarEstado();
                loadPersistentData();
                
                rawDataLines = dados;
                currentCabecalho = cabecalho;

                if (dados.length === 0 || (dados.length === 1 && dados[0].trim() === '')) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 11;
                    cell.textContent = "Nenhum dado encontrado para importar.";
                    cell.style.textAlign = 'center';
                    cell.style.color = 'red';
                    row.appendChild(cell);
                    tabelaCorpo.appendChild(row);
                    atualizarResumo();
                    return;
                }
                
                const indiceCarretaDoca = cabecalho.indexOf('Carreta na Doca');
                if (indiceCarretaDoca !== -1) {
                    dados.sort((a, b) => {
                        const timeA = parseCsvLine(a)[indiceCarretaDoca];
                        const timeB = parseCsvLine(b)[indiceCarretaDoca];
                        if (!timeA && !timeB) return 0;
                        if (!timeA) return 1;
                        if (!timeB) return -1;
                        return timeA.localeCompare(timeB);
                    });
                }
                
                dados.forEach(linha => {
                    const colunas = parseCsvLine(linha);
                    
                    if (colunas.length < cabecalho.length) {
                        const row = document.createElement('tr');
                        const cell = document.createElement('td');
                        cell.colSpan = 11;
                        cell.textContent = `Erro de formatação na linha: Dados incompletos. Colunas esperadas: ${cabecalho.length}, encontradas: ${colunas.length}.`;
                        cell.style.textAlign = 'center';
                        cell.style.color = 'red';
                        row.appendChild(cell);
                        tabelaCorpo.appendChild(row);
                        return;
                    }

                    if (colunas.length > 1) {
                        
                        const dadosImportados = {};
                        const cabecalhosDesejados = ['JANELA', 'CARRETA NA DOCA', 'PLACA DO VEÍCULO', 'CLIENTE', 'VOLUMES'];

                        cabecalhosDesejados.forEach(cabecalhoDesejado => {
                            let valor = 'N/A';
                            const nomeColunaCSV = Object.keys(colunaMap).find(key => colunaMap[key] === cabecalhoDesejado);
                            
                            if (nomeColunaCSV) {
                                const indice = cabecalho.indexOf(nomeColunaCSV);
                                if (indice !== -1 && colunas[indice]) {
                                    valor = colunas[indice].replace(/"/g, '').trim();
                                }
                            }
                            dadosImportados[cabecalhoDesejado] = valor;
                        });

                        const placa = dadosImportados['PLACA DO VEÍCULO'];
                        const cliente = dadosImportados['CLIENTE'];
                        const volumes = parseInt(dadosImportados['VOLUMES']) || 0;
                        const carretaDoca = dadosImportados['CARRETA NA DOCA'];
                        const janela = dadosImportados['JANELA'];

                        const isIncomplete = !placa || !cliente || placa === 'N/A' || cliente === 'N/A' || volumes === 0;
                        
                        const row = document.createElement('tr');

                        const horaCarretaDoca = colunas[cabecalho.indexOf('Carreta na Doca')];
                        if (horaCarretaDoca) {
                            const hora = parseInt(horaCarretaDoca.split(':')[0]);
                            if ((hora >= 1 && hora <= 4) || (hora >= 20 && hora <= 23)) {
                                row.classList.add('cinza-claro');
                            }
                        }
                        
                        const chaveUnica = `${placa}-${cliente}-${carretaDoca}-${janela}`;
                        const estadoAtual = estadoPorPlaca[chaveUnica] || {};
                        
                        ['JANELA', 'CARRETA NA DOCA', 'PLACA DO VEÍCULO', 'CLIENTE', 'VOLUMES'].forEach(campo => {
                            const cell = document.createElement('td');
                            cell.textContent = dadosImportados[campo];
                            row.appendChild(cell);
                        });
                        
                        const conferenteCell = document.createElement('td');
                        const conferenteSelect = document.createElement('select');
                        conferentes.forEach(conferente => {
                            const option = document.createElement('option');
                            option.value = conferente;
                            option.textContent = conferente;
                            conferenteSelect.appendChild(option);
                        });
                        if (estadoAtual.conferente) {
                            conferenteSelect.value = estadoAtual.conferente;
                        } else {
                            conferenteSelect.value = 'Selecione...';
                        }
                        conferenteSelect.addEventListener('change', (e) => {
                            estadoPorPlaca[chaveUnica] = estadoPorPlaca[chaveUnica] || {};
                            estadoPorPlaca[chaveUnica].conferente = e.target.value;
                            salvarEstado();
                            atualizarResumo(); 
                        });
                        conferenteCell.appendChild(conferenteSelect);
                        row.appendChild(conferenteCell);
                        
                        const docaCell = document.createElement('td');
                        const docaSelect = document.createElement('select');
                        docas.forEach(doca => {
                            const option = document.createElement('option');
                            const docaValue = doca.toString(); 
                            option.value = docaValue;
                            option.textContent = docaValue;
                            docaSelect.appendChild(option);
                        });
                        if (estadoAtual.doca) {
                            docaSelect.value = estadoAtual.doca;
                        }
                        docaSelect.addEventListener('change', (e) => {
                            estadoPorPlaca[chaveUnica] = estadoPorPlaca[chaveUnica] || {};
                            estadoPorPlaca[chaveUnica].doca = e.target.value;
                            salvarEstado();
                            atualizarResumo(); 
                        });
                        docaCell.appendChild(docaSelect);
                        row.appendChild(docaCell);

                        const inicioCell = document.createElement('td');
                        const inicioInput = document.createElement('input');
                        inicioInput.type = 'time';
                        if (isIncomplete) {
                            inicioInput.disabled = true;
                        } else {
                            if (estadoAtual.inicio) {
                                inicioInput.value = estadoAtual.inicio;
                            }
                            inicioInput.addEventListener('change', (e) => {
                                estadoPorPlaca[chaveUnica] = estadoPorPlaca[chaveUnica] || {};
                                estadoPorPlaca[chaveUnica].inicio = e.target.value;
                                salvarEstado();
                                
                                const statusDot = e.target.closest('tr').querySelector('.status-dot-table');
                                const fimTime = estadoPorPlaca[chaveUnica].fim;
                                const obsValue = estadoPorPlaca[chaveUnica].obs;
                                if (statusDot) {
                                    atualizarStatusCor(e.target.value, fimTime, obsValue, horaCarretaDoca, statusDot, isIncomplete);
                                }
                                atualizarResumo(); 
                            });
                        }
                        inicioCell.appendChild(inicioInput);
                        row.appendChild(inicioCell);

                        const fimCell = document.createElement('td');
                        const fimInput = document.createElement('input');
                        fimInput.type = 'time';
                        if (isIncomplete) {
                            fimInput.disabled = true;
                        } else {
                            if (estadoAtual.fim) {
                                fimInput.value = estadoAtual.fim;
                            }
                            fimInput.addEventListener('change', (e) => {
                                estadoPorPlaca[chaveUnica] = estadoPorPlaca[chaveUnica] || {};
                                estadoPorPlaca[chaveUnica].fim = e.target.value;
                                salvarEstado();
                                
                                const statusDot = e.target.closest('tr').querySelector('.status-dot-table');
                                const inicioTime = estadoPorPlaca[chaveUnica].inicio;
                                const obsValue = estadoPorPlaca[chaveUnica].obs;
                                if (statusDot) {
                                    atualizarStatusCor(inicioTime, e.target.value, obsValue, horaCarretaDoca, statusDot, isIncomplete);
                                }
                                atualizarResumo(); 
                            });
                        }
                        fimCell.appendChild(fimInput);
                        row.appendChild(fimCell);
                        
                        const statusCell = document.createElement('td');
                        statusCell.classList.add('status-cell-table');
                        const statusDot = document.createElement('div');
                        statusDot.classList.add('status-dot-table');
                        statusCell.appendChild(statusDot);

                        atualizarStatusCor(estadoAtual.inicio, estadoAtual.fim, estadoAtual.obs, horaCarretaDoca, statusDot, isIncomplete);
                        
                        row.appendChild(statusCell);

                        const obsCell = document.createElement('td');
                        const obsSelect = document.createElement('select');
                        
                        const selecioneOption = document.createElement('option');
                        selecioneOption.value = '';
                        selecioneOption.textContent = 'Selecione...';
                        obsSelect.appendChild(selecioneOption);
                        
                        observacoesList.forEach(obs => {
                            const option = document.createElement('option');
                            option.value = obs;
                            option.textContent = obs;
                            obsSelect.appendChild(option);
                        });
                        
                        if (estadoAtual.obs) {
                            obsSelect.value = estadoAtual.obs;
                        }
                        
                        obsSelect.addEventListener('change', (e) => {
                            estadoPorPlaca[chaveUnica] = estadoPorPlaca[chaveUnica] || {};
                            estadoPorPlaca[chaveUnica].obs = e.target.value;
                            salvarEstado();
                            
                            const statusDot = e.target.closest('tr').querySelector('.status-dot-table');
                            const inicioTime = estadoPorPlaca[chaveUnica].inicio;
                            const fimTime = estadoPorPlaca[chaveUnica].fim;
                            if (statusDot) {
                                atualizarStatusCor(inicioTime, fimTime, e.target.value, horaCarretaDoca, statusDot, isIncomplete);
                            }
                            atualizarResumo(); 
                        });
                        
                        obsCell.appendChild(obsSelect);
                        row.appendChild(obsCell);
                        
                        tabelaCorpo.appendChild(row);
                    }
                });
                
                if (isNewImport) {
                    if (Notification.permission === "granted") {
                        console.log("Notificação inicial de sucesso enviada.");
                        new Notification("Painel APA atualizado com sucesso!", {
                            body: "Você será lembrado de atualizar novamente em 30 minutos.",
                            icon: 'imagem/baixados.png' 
                        });
                        scheduleNextNotification();
                    } else {
                        console.log("Não é possível enviar notificação. Permissão não concedida.");
                    }
                }

                atualizarResumo();
            }

            function atualizarResumo() {
                carregarEstado();
                
                let diurno = {
                    programadoComVeiculos: 0,
                    programadoVolumes: 0,
                    programadoSemVeiculos: 0, 
                    programadoJanelasDisponiveis: 0,
                    realizadoCarregados: 0,
                    realizadoVolumesCarregados: 0,
                    realizadoCarregando: 0,
                    realizadoVolumesCarregando: 0,
                    realizadoJanelasPerdidas: 0
                };

                let noturno = {
                    programadoComVeiculos: 0,
                    programadoVolumes: 0,
                    programadoSemVeiculos: 0,
                    programadoJanelasDisponiveis: 0,
                    realizadoCarregados: 0,
                    realizadoVolumesCarregados: 0,
                    realizadoCarregando: 0,
                    realizadoVolumesCarregando: 0,
                    realizadoJanelasPerdidas: 0
                };
                
                if (rawDataLines.length > 0 && currentCabecalho.length > 0) {
                    rawDataLines.forEach(linha => {
                        const colunas = parseCsvLine(linha);
                        
                        const placaIndex = currentCabecalho.indexOf('Placa');
                        const clienteIndex = currentCabecalho.indexOf('Cliente');
                        const volumesIndex = currentCabecalho.indexOf('Volume');
                        const carretaDocaIndex = currentCabecalho.indexOf('Carreta na Doca');
                        const janelaIndex = currentCabecalho.indexOf('Janela');

                        if (placaIndex === -1 || clienteIndex === -1 || volumesIndex === -1 || carretaDocaIndex === -1 || janelaIndex === -1) {
                            return; 
                        }
                        
                        const placa = colunas[placaIndex];
                        const cliente = colunas[clienteIndex];
                        const volumes = parseInt(colunas[volumesIndex]) || 0;
                        const carretaDoca = colunas[carretaDocaIndex];
                        const hora = carretaDoca ? parseInt(carretaDoca.split(':')[0]) : null;
                        const janela = colunas[janelaIndex];

                        let turno;
                        if (hora >= 8 && hora <= 19) {
                            turno = diurno;
                        } else if ((hora >= 1 && hora <= 4) || (hora >= 20 && hora <= 23)) {
                            turno = noturno;
                        } else {
                            return; 
                        }
                        
                        const chaveUnica = `${placa}-${cliente}-${carretaDoca}-${janela}`;
                        const estadoAtual = estadoPorPlaca[chaveUnica] || {};
                        
                        const temPlaca = (placa && placa !== 'N/A');
                        const temCliente = (cliente && cliente !== 'N/A');
                        const temVolumes = (volumes > 0);
                        const temInicio = estadoAtual.inicio;
                        const temFim = estadoAtual.fim;
                        
                        if (temPlaca && temCliente && temVolumes) {
                            turno.programadoComVeiculos++;
                            turno.programadoVolumes += volumes;
                        } else if (!temPlaca && temCliente) {
                            turno.programadoSemVeiculos++;
                        } else if(!temPlaca && !temCliente) {
                            turno.programadoJanelasDisponiveis++;
                        }
                        
                        if (temFim) {
                            turno.realizadoCarregados++;
                            turno.realizadoVolumesCarregados += volumes;
                        } else if (temInicio && !temFim) {
                            turno.realizadoCarregando++;
                            turno.realizadoVolumesCarregando += volumes;
                        }
                    });
                }
                
                diurno.realizadoJanelasPerdidas = diurno.programadoSemVeiculos + diurno.programadoJanelasDisponiveis;
                noturno.realizadoJanelasPerdidas = noturno.programadoSemVeiculos + noturno.programadoJanelasDisponiveis;

                function gerarHTMLResumo(dadosTurno, titulo) {
                    const totalProgramado = dadosTurno.programadoComVeiculos + dadosTurno.programadoSemVeiculos + dadosTurno.programadoJanelasDisponiveis;
                    const totalRealizado = dadosTurno.realizadoCarregados + dadosTurno.realizadoCarregando;
                    const totalRealizadoComJanelasPerdidas = totalRealizado + dadosTurno.realizadoJanelasPerdidas;

                    const pctComVeiculos = totalProgramado > 0 ? ((dadosTurno.programadoComVeiculos / totalProgramado) * 100).toFixed(0) : 0;
                    const pctSemVeiculos = totalProgramado > 0 ? ((dadosTurno.programadoSemVeiculos / totalProgramado) * 100).toFixed(0) : 0;
                    const pctJanelasDisponiveis = totalProgramado > 0 ? ((dadosTurno.programadoJanelasDisponiveis / totalProgramado) * 100).toFixed(0) : 0;
                    
                    const pctCarregados = totalRealizado > 0 ? ((dadosTurno.realizadoCarregados / totalRealizado) * 100).toFixed(0) : 0;
                    const pctCarregando = totalRealizado > 0 ? ((dadosTurno.realizadoCarregando / totalRealizado) * 100).toFixed(0) : 0;
                    const pctJanelasPerdidas = totalRealizadoComJanelasPerdidas > 0 ? ((totalJanelasPerdidasGeral / totalFinalizadoGeral) * 100).toFixed(0) : 0;

                    const cardClass = titulo.includes('NOTURNO') ? 'summary-card-noturno' : '';

                    return `
                        <div class="${cardClass}">
                            <h3>${titulo}</h3>
                            <table class="resumo-table">
                                <thead>
                                    <tr>
                                        <th>STATUS</th>
                                        <th>VEÍCULOS</th>
                                        <th>%</th>
                                        <th>VOLUMES</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="5" style="background-color: #f2f2f2; font-weight: bold;">PROGRAMADO</td></tr>
                                    <tr>
                                        <td class="left-align">Com Veículos</td>
                                        <td>${dadosTurno.programadoComVeiculos}</td>
                                        <td>${pctComVeiculos}%</td>
                                        <td>${dadosTurno.programadoVolumes}</td>
                                        <td>100%</td>
                                    </tr>
                                    <tr>
                                        <td class="left-align">Sem Veículos</td>
                                        <td>${dadosTurno.programadoSemVeiculos}</td>
                                        <td>${pctSemVeiculos}%</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td class="left-align">Janelas Disponíveis</td>
                                        <td>${dadosTurno.programadoJanelasDisponiveis}</td>
                                        <td>${pctJanelasDisponiveis}%</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                    <tr><td colspan="5" style="background-color: #f2f2f2; font-weight: bold;">REALIZADO</td></tr>
                                    <tr>
                                        <td class="left-align">Carregados</td>
                                        <td>${dadosTurno.realizadoCarregados}</td>
                                        <td>${pctCarregados}%</td>
                                        <td>${dadosTurno.realizadoVolumesCarregados}</td>
                                        <td>${pctCarregados}%</td>
                                    </tr>
                                    <tr>
                                        <td class="left-align">Carregando</td>
                                        <td>${dadosTurno.realizadoCarregando}</td>
                                        <td>${pctCarregando}%</td>
                                        <td>${dadosTurno.realizadoVolumesCarregando}</td>
                                        <td>${pctCarregando}%</td>
                                    </tr>
                                    <tr>
                                        <td class="left-align">Janelas Perdidas</td>
                                        <td>${dadosTurno.realizadoJanelasPerdidas}</td>
                                        <td>${pctJanelasPerdidas}%</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                const totalProgramadoGeral = diurno.programadoComVeiculos + noturno.programadoComVeiculos + diurno.programadoSemVeiculos + noturno.programadoSemVeiculos + diurno.programadoJanelasDisponiveis + noturno.programadoJanelasDisponiveis;
                const totalVolumesProgramadosGeral = diurno.programadoVolumes + noturno.programadoVolumes;
                const totalRealizadoGeral = diurno.realizadoCarregados + noturno.realizadoCarregados + diurno.realizadoCarregando + noturno.realizadoCarregando;
                const totalVolumesRealizadosGeral = diurno.realizadoVolumesCarregados + noturno.realizadoVolumesCarregando;
                const totalJanelasPerdidasGeral = diurno.realizadoJanelasPerdidas + noturno.realizadoJanelasPerdidas;
                const totalFinalizadoGeral = totalRealizadoGeral + totalJanelasPerdidasGeral;
                const pctJanelasPerdidasGeral = totalFinalizadoGeral > 0 ? ((totalJanelasPerdidasGeral / totalFinalizadoGeral) * 100).toFixed(0) : 0;
                
                summaryInfoDiv.innerHTML = `
                    ${gerarHTMLResumo(diurno, "COMERCIAL DIURNO")}
                    <hr style="margin: 20px 0; border: none; border-top: 2px solid #ccc;">
                    ${gerarHTMLResumo(noturno, "COMERCIAL NOTURNO")}
                    <hr style="margin: 20px 0; border: none; border-top: 2px solid #ccc;">
                    <h3>RESULTADO GERAL</h3>
                    <table class="resumo-table">
                        <thead>
                            <tr>
                                <th>STATUS</th>
                                <th>JANELAS</th>
                                <th>VOLUMES</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="left-align">Programado</td>
                                <td>${totalProgramadoGeral}</td>
                                <td>${totalVolumesProgramadosGeral}</td>
                            </tr>
                            <tr>
                                <td class="left-align">Realizado</td>
                                <td>${totalRealizadoGeral}</td>
                                <td>${totalVolumesRealizadosGeral}</td>
                            </tr>
                            <tr>
                                <td class="left-align">Janelas Perdidas</td>
                                <td>${totalJanelasPerdidasGeral}</td>
                                <td>${pctJanelasPerdidasGeral}%</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }

            function exportTableToExcel() {
                if (!rawDataLines.length) {
                    alert("Não há dados para exportar.");
                    return;
                }
            
                // Criar uma nova tabela temporária em memória
                const tempTable = document.createElement('table');
                tempTable.style.display = 'none';
                document.body.appendChild(tempTable);
            
                const headers = ['JANELA', 'CARRETA NA DOCA', 'PLACA DO VEÍCULO', 'CLIENTE', 'VOLUMES', 'CONFERENTE', 'DOCA', 'INÍCIO', 'FIM', 'OBS'];
                const headerRow = tempTable.createTHead().insertRow();
                headers.forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
            
                const body = tempTable.createTBody();
                
                rawDataLines.forEach(line => {
                    const colunas = parseCsvLine(line);
                    const placaIndex = currentCabecalho.indexOf('Placa');
                    const clienteIndex = currentCabecalho.indexOf('Cliente');
                    const carretaDocaIndex = currentCabecalho.indexOf('Carreta na Doca');
                    const janelaIndex = currentCabecalho.indexOf('Janela');
            
                    const placa = colunas[placaIndex];
                    const cliente = colunas[clienteIndex];
                    const carretaDoca = colunas[carretaDocaIndex];
                    const janela = colunas[janelaIndex];
            
                    const chaveUnica = `${placa}-${cliente}-${carretaDoca}-${janela}`;
                    const estado = estadoPorPlaca[chaveUnica] || {};
            
                    const row = body.insertRow();
                    const dadosImportados = {
                        'JANELA': colunas[janelaIndex],
                        'CARRETA NA DOCA': colunas[carretaDocaIndex],
                        'PLACA DO VEÍCULO': colunas[placaIndex],
                        'CLIENTE': colunas[clienteIndex],
                        'VOLUMES': colunas[currentCabecalho.indexOf('Volume')],
                        'CONFERENTE': estado.conferente || '',
                        'DOCA': estado.doca || '',
                        'INÍCIO': estado.inicio || '',
                        'FIM': estado.fim || '',
                        'OBS': estado.obs || ''
                    };
            
                    headers.forEach(header => {
                        const cell = row.insertCell();
                        cell.textContent = dadosImportados[header];
                    });
                });
            
                const data = new Date();
                const dia = String(data.getDate()).padStart(2, '0');
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const ano = data.getFullYear();
                const horas = String(data.getHours()).padStart(2, '0');
                const minutos = String(data.getMinutes()).padStart(2, '0');
                const filename = `Painel_APA_${dia}-${mes}-${ano}_${horas}-${minutos}.xls`;
                
                const tableHtml = tempTable.outerHTML.replace(/ /g, '%20');
            
                const downloadLink = document.createElement("a");
                document.body.appendChild(downloadLink);
                downloadLink.href = 'data:application/vnd.ms-excel,' + tableHtml;
                downloadLink.download = filename;
                downloadLink.click();
                document.body.removeChild(downloadLink);
                document.body.removeChild(tempTable);
            }

            fileInput.addEventListener('change', (e) => {
                requestNotificationPermission();
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const { cabecalho, dados } = parseData(e.target.result);
                            renderizarTabela(dados, cabecalho);
                        } catch (error) {
                            console.error('Erro ao processar o arquivo:', error);
                            alert(`Erro ao processar o arquivo. Verifique o console para mais detalhes. Mensagem: ${error.message}`);
                            atualizarResumo();
                        }
                    };
                    reader.readAsText(file);
                } else {
                    atualizarResumo();
                }
            });

            pasteBtn.addEventListener('click', () => {
                requestNotificationPermission();
                const rawData = pasteData.value;
                if (!rawData.trim()) {
                    alert('Por favor, cole os dados na área de texto.');
                    return;
                }

                try {
                    const { cabecalho, dados } = parseData(rawData);
                    renderizarTabela(dados, cabecalho);
                } catch (error) {
                    console.error('Erro ao processar dados colados:', error);
                    alert(`Erro ao processar os dados colados. Mensagem: ${error.message}`);
                    atualizarResumo();
                }
            });
            
            fullscreenBtn.addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen();
                }
            });

            exportExcelBtn.addEventListener('click', () => {
                exportTableToExcel();
            });

            document.addEventListener('fullscreenchange', () => {
                if (document.fullscreenElement) {
                    document.body.classList.add('fullscreen-mode');
                } else {
                    document.body.classList.remove('fullscreen-mode');
                }
            });

            requestNotificationPermission();

            // Adicionando a funcionalidade dos novos botões
            addConferenteBtn.addEventListener('click', () => {
                modalConferente.style.display = 'flex';
                inputConferente.focus();
            });

            closeConferenteModal.addEventListener('click', () => {
                modalConferente.style.display = 'none';
            });

            formConferente.addEventListener('submit', (e) => {
                e.preventDefault();
                const novoConferente = inputConferente.value.trim().toUpperCase();
                if (novoConferente && !conferentes.includes(novoConferente)) {
                    conferentes.push(novoConferente);
                    sortAndSaveConferentes();
                    renderizarTabela(rawDataLines, currentCabecalho, false); 
                    alert(`Conferente "${novoConferente}" adicionado com sucesso!`);
                } else {
                    alert('Conferente já existe ou é inválido.');
                }
                modalConferente.style.display = 'none';
                inputConferente.value = '';
            });

            addObsBtn.addEventListener('click', () => {
                modalObs.style.display = 'flex';
                inputObs.focus();
            });
            
            closeObsModal.addEventListener('click', () => {
                modalObs.style.display = 'none';
            });

            formObs.addEventListener('submit', (e) => {
                e.preventDefault();
                const novaObservacao = inputObs.value.trim().toUpperCase();
                if (novaObservacao && !observacoesList.includes(novaObservacao)) {
                    observacoesList.push(novaObservacao);
                    sortAndSaveObservacoes();
                    renderizarTabela(rawDataLines, currentCabecalho, false);
                    alert(`Observação "${novaObservacao}" adicionada com sucesso!`);
                } else {
                    alert('Observação já existe ou é inválida.');
                }
                modalObs.style.display = 'none';
                inputObs.value = '';
            });
            
        });
    </script>
</body>
</html>